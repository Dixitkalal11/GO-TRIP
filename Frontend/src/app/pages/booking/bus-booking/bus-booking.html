<!-- Bus Search Form -->
<div class="bus-search-container" *ngIf="!showResults">
  <div class="booking-container">
    <div class="booking-content-wrapper">
      <div class="search-form">
        <div class="search-header">
          <button class="back-btn" (click)="goBack()">
            <i class="bi bi-arrow-left"></i> Back to Travel Modes
          </button>
          <h1 class="page-title" style="display: none;">Bus Booking</h1>
        </div>
        
        <div class="form-header">
          <div class="search-title-card">
            <h1 class="search-title">Find Your Perfect Bus Trip</h1>
          </div>
          <div class="logo-container">
            <img src="assets/images/GoTrip Logo.png" alt="GoTrip Logo" class="card-logo">
          </div>
        </div>

        <!-- Trip Type (styled) moved to top -->
        <div class="trip-type-container">
          <div class="trip-type-options">
            <label class="trip-type-option">
              <input type="radio" name="tripType" value="one-way" [(ngModel)]="tripType" (change)="onTripTypeChange()">
              <span class="trip-type-label">One Way</span>
            </label>
            <label class="trip-type-option">
              <input type="radio" name="tripType" value="round-trip" [(ngModel)]="tripType" (change)="onTripTypeChange()">
              <span class="trip-type-label">Round Trip</span>
            </label>
          </div>
        </div>

      <!-- Main Search Form -->
      <div class="main-search-form" [class.round-trip]="tripType === 'round-trip'">
        <!-- From Field -->
        <div class="search-field">
          <label class="field-label">FROM</label>
          <select [(ngModel)]="fromCity" name="from" required (change)="onFromCityChange()">
            <option value="">From City</option>
            <option *ngFor="let city of availableCities" [value]="city">{{ city }}</option>
          </select>
        </div>

        <!-- Swap Button -->
        <div class="swap-button" (click)="swapCities()">
          <i class="bi bi-arrow-left-right"></i>
        </div>

        <!-- To Field -->
        <div class="search-field">
          <label class="field-label">TO</label>
          <select [(ngModel)]="toCity" name="to" required (change)="onToCityChange()">
            <option value="">To City</option>
            <option *ngFor="let city of availableCities" [value]="city" [disabled]="city === fromCity">{{ city }}</option>
          </select>
        </div>

        <!-- Departure Date -->
        <div class="search-field">
          <label class="field-label">DEPARTURE</label>
          <input type="date" [(ngModel)]="travelDate" name="date" [min]="getTodayDate()" required (change)="saveBookingState()" />
        </div>

        <!-- Return Date - Only show for Round Trip -->
        <div class="search-field" *ngIf="tripType === 'round-trip'">
          <label class="field-label">RETURN</label>
          <input type="date" [(ngModel)]="returnDate" name="returnDate" [min]="getMinReturnDate()" placeholder="Add Return for bigger discounts" (change)="saveBookingState()" />
        </div>
      </div>

        <!-- Special Fares -->
        <div class="discount-section">
          <div class="special-fares">
            <div class="fare-option"
                 [class.active]="selectedDiscountType === 'regular'"
                 [class.disabled]="!canUseDiscountType('regular')"
                 (click)="selectDiscountType('regular')">
              <span>Regular</span>
              <small>Standard pricing</small>
            </div>
            <div class="fare-option"
                 [class.active]="selectedDiscountType === 'student'"
                 [class.disabled]="!canUseDiscountType('student')"
                 (click)="selectDiscountType('student')">
              <span>Student</span>
              <small>{{getCurrentCoinsEarned('student')}} coins bonus</small>
              <div class="booking-info" *ngIf="userBookingStats.totalBookings < 3">
                <small>First 3 bookings: +5 bonus!</small>
              </div>
              <div class="coins-info" *ngIf="!canUseDiscountType('student')">
                <small>Need {{getDiscountInfo('student').coinsRequired}} coins</small>
              </div>
            </div>
            <div class="fare-option"
                 [class.active]="selectedDiscountType === 'senior'"
                 [class.disabled]="!canUseDiscountType('senior')"
                 (click)="selectDiscountType('senior')">
              <span>Senior Citizen</span>
              <small>{{getCurrentCoinsEarned('senior')}} coins bonus</small>
              <div class="booking-info" *ngIf="userBookingStats.totalBookings < 3">
                <small>First 3 bookings: +5 bonus!</small>
              </div>
              <div class="coins-info" *ngIf="!canUseDiscountType('senior')">
                <small>Need {{getDiscountInfo('senior').coinsRequired}} coins</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Search Button -->
        <div class="search-btn-wrapper">
          <button type="submit" class="search-btn" (click)="searchBuses()" [disabled]="!fromCity || !toCity || !travelDate || (tripType === 'round-trip' && !returnDate)">
            <i class="bi bi-search"></i>
            SEARCH BUSES
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bus Results -->
<div class="bus-results-container" *ngIf="showResults && !selectedBus">
  <div class="container">
    <div class="results-header">
      <button class="back-btn" (click)="goBackToSearchForm()">
        <i class="bi bi-arrow-left"></i> Modify Search
      </button>
      <div class="route-info">
        <span class="from-city">{{ fromCity }}</span>
        <i class="bi bi-arrow-right"></i>
        <span class="to-city">{{ toCity }}</span>
        <span class="travel-date">{{ travelDate }}</span>
      </div>
    </div>

    <div class="results-count">
      <h2>{{ busOptions.length }} buses found from {{ fromCity }} to {{ toCity }} on {{ travelDate }}</h2>
    </div>

    <div class="bus-options">
      <div class="bus-card" *ngFor="let bus of busOptions">
        <div class="bus-header">
          <div class="operator-info">
            <div class="bus-icon">
              <i class="bi bi-bus-front"></i>
            </div>
            <div class="operator-details">
              <span class="operator-name">{{ bus.operator }}</span>
              <span class="bus-type">{{ bus.type }}</span>
            </div>
          </div>
          <div class="rating">
            <i class="bi bi-star-fill"></i>
            <span>{{ bus.rating }} ({{ bus.reviews }} reviews)</span>
          </div>
        </div>

        <div class="bus-timings">
          <div class="departure">
            <div class="time">{{ bus.departure }}</div>
            <div class="city">{{ fromCity }}</div>
          </div>
          <div class="duration-line">
            <div class="line"></div>
            <div class="duration">{{ bus.duration }}</div>
            <div class="line"></div>
          </div>
          <div class="arrival">
            <div class="time">{{ bus.arrival }}</div>
            <div class="city">{{ toCity }}</div>
          </div>
        </div>

        <div class="bus-amenities">
          <span class="amenity" *ngFor="let amenity of bus.amenities">{{ amenity }}</span>
        </div>

        <div class="bus-footer">
          <div class="availability">
            <i class="bi bi-lightning-fill"></i>
            <span>{{ bus.seatsLeft }} seats left</span>
          </div>
          <div class="price-section">
            <div class="price">‚Çπ {{ bus.price }}</div>
            <div class="price-label">per person</div>
          </div>
          <button class="select-btn" (click)="selectBus(bus)">
            Select
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bus Booking Details -->
<div class="bus-booking-container" *ngIf="selectedBus">
  <div class="container">
    <!-- Back Button -->
    <div class="results-header" style="margin-bottom: 1.5rem;">
      <button class="back-btn" (click)="goBackToSearch()">
        <i class="bi bi-arrow-left"></i> Back to Bus Options
      </button>
      <div class="route-info">
        <span class="from-city">{{ fromCity }}</span>
        <i class="bi bi-arrow-right"></i>
        <span class="to-city">{{ toCity }}</span>
        <span class="travel-date">{{ travelDate }}</span>
      </div>
    </div>
    
    <!-- Trip Details Card -->
    <div class="trip-details-card">
      <div class="card-header">
        <i class="bi bi-bus-front"></i>
        <h3>Bus Trip Details</h3>
      </div>
      <div class="trip-info">
        <div class="info-item">
          <span class="label">From</span>
          <span class="value">{{ fromCity }}</span>
        </div>
        <div class="info-item">
          <span class="label">To</span>
          <span class="value">{{ toCity }}</span>
        </div>
        <div class="info-item">
          <span class="label">Date</span>
          <span class="value">{{ travelDate }}</span>
        </div>
        <div class="info-item">
          <span class="label">Bus</span>
          <span class="value">{{ selectedBus.operator }} - {{ selectedBus.type }}</span>
        </div>
        <div class="info-item">
          <span class="label">Price per person</span>
          <span class="value price-value">‚Çπ{{ selectedBus.price }}</span>
          <span class="coins-badge">+{{ getTotalCoins() }} coins</span>
        </div>
      </div>
    </div>

    <!-- Primary Contact Details Section -->
    <div class="contact-details-section">
      <div class="section-header">
        <div class="header-left">
          <i class="bi bi-telephone-fill"></i>
          <h3>üìû Primary Contact Details</h3>
          <span class="section-subtitle">(Only once per booking)</span>
        </div>
      </div>
      <div class="contact-form">
        <form #contactForm="ngForm">
          <div class="form-row">
            <div class="form-group">
              <label>Mobile Number<span class="required-asterisk">*</span></label>
              <div class="input-group">
                <i class="bi bi-phone"></i>
                <input 
                  type="tel" 
                  name="mobileNumber"
                  [(ngModel)]="bookingContact.mobileNumber" 
                  placeholder="Enter mobile number"
                  required
                  pattern="[0-9]{10}"
                  #mobileNumber="ngModel"
                  (blur)="onMobileBlur()">
              </div>
              <app-form-error [control]="mobileNumber.control" fieldName="Mobile number"></app-form-error>
            </div>
            <div class="form-group">
              <label>Email ID<span class="required-asterisk">*</span></label>
              <div class="input-group">
                <i class="bi bi-envelope"></i>
                <input 
                  type="email" 
                  name="emailId"
                  [(ngModel)]="bookingContact.emailId" 
                  placeholder="Enter email address"
                  required
                  email
                  #emailId="ngModel"
                  (blur)="onEmailBlur()">
              </div>
              <app-form-error [control]="emailId.control" fieldName="Email"></app-form-error>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Passenger Details Section -->
    <div class="passenger-details-section">
      <div class="section-header">
        <div class="header-left">
          <i class="bi bi-people-fill"></i>
          <h3>üßç‚Äç‚ôÇÔ∏è Mandatory Passenger Details</h3>
          <span class="section-subtitle">({{ passengers.length }} passenger{{ passengers.length > 1 ? 's' : '' }})</span>
        </div>
        <button class="add-passenger-btn" (click)="addPassenger()" *ngIf="passengers.length < 6">
          <i class="bi bi-plus"></i> Add Passenger
        </button>
      </div>

      <div class="passenger-forms">
        <div class="passenger-form" *ngFor="let passenger of passengers; let i = index">
          <div class="passenger-header">
            <h4>Passenger {{ i + 1 }}</h4>
            <button class="remove-passenger-btn" (click)="removePassenger(i)" *ngIf="passengers.length > 1">
              <i class="bi bi-trash"></i>
            </button>
          </div>

          <!-- Mandatory Fields -->
          <div class="form-section">
            <h5 class="section-title">Required Information</h5>
            <div class="form-row">
              <div class="form-group">
                <label>Full Name<span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <i class="bi bi-person"></i>
                  <input 
                    type="text" 
                    name="fullName{{i}}"
                    [(ngModel)]="passenger.fullName" 
                    placeholder="As per ID proof"
                    required
                    #fullName="ngModel"
                    (blur)="passenger.fullName = validationService.removeExtraSpaces(passenger.fullName)">
                </div>
                <app-form-error [control]="fullName.control" fieldName="Full name"></app-form-error>
              </div>
              <div class="form-group">
                <label>Age<span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <i class="bi bi-calendar"></i>
                  <input 
                    type="number" 
                    name="age{{i}}"
                    [(ngModel)]="passenger.age" 
                    placeholder="Age" 
                    min="1" 
                    max="120"
                    required
                    #age="ngModel">
                </div>
                <app-form-error [control]="age.control" fieldName="Age"></app-form-error>
              </div>
              <div class="form-group">
                <label>Gender<span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <select 
                    name="gender{{i}}"
                    [(ngModel)]="passenger.gender"
                    required
                    #gender="ngModel">
                    <option value="">Select gender</option>
                    <option *ngFor="let genderOption of genderOptions" [value]="genderOption">{{ genderOption }}</option>
                  </select>
                  <i class="bi bi-chevron-down"></i>
                </div>
                <app-form-error [control]="gender.control" fieldName="Gender"></app-form-error>
              </div>
              <div class="form-group">
                <label>Seat Number<span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <i class="bi bi-geo-alt"></i>
                  <input 
                    type="text" 
                    name="seatNumber{{i}}"
                    [(ngModel)]="passenger.seatNumber" 
                    placeholder="Select from seat map" 
                    readonly
                    required
                    #seatNumber="ngModel">
                </div>
                <app-form-error [control]="seatNumber.control" fieldName="Seat number"></app-form-error>
              </div>
            </div>
          </div>

          <!-- Optional Fields -->
          <div class="form-section" *ngIf="isIdProofRequired()">
            <h5 class="section-title">ü™™ ID Proof Details <span class="required">*</span></h5>
            <div class="form-row">
              <div class="form-group" [class.field-error]="isIdProofRequired() && !passenger.idProofType">
                <label>ID Proof Type <span class="required">*</span></label>
                <div class="input-group" [class.input-error]="isIdProofRequired() && !passenger.idProofType">
                  <select [(ngModel)]="passenger.idProofType" [class.error-border]="isIdProofRequired() && !passenger.idProofType">
                    <option value="">Select ID type</option>
                    <option *ngFor="let idType of idProofTypes" [value]="idType">{{ idType }}</option>
                  </select>
                  <i class="bi bi-chevron-down"></i>
                </div>
                <span class="error-message" *ngIf="isIdProofRequired() && !passenger.idProofType">ID Proof Type is required</span>
              </div>
              <div class="form-group" [class.field-error]="isIdProofRequired() && !passenger.idProofNumber">
                <label>ID Proof Number <span class="required">*</span></label>
                <div class="input-group" [class.input-error]="isIdProofRequired() && !passenger.idProofNumber">
                  <i class="bi bi-card-text"></i>
                  <input type="text" [(ngModel)]="passenger.idProofNumber" placeholder="Enter ID number" [class.error-border]="isIdProofRequired() && !passenger.idProofNumber">
                </div>
                <span class="error-message" *ngIf="isIdProofRequired() && !passenger.idProofNumber">ID Proof Number is required</span>
              </div>
            </div>
          </div>


          <div class="form-section">
            <h5 class="section-title">üö® Emergency Contact</h5>
            <div class="form-row">
              <div class="form-group full-width">
                <label>Emergency Contact Number</label>
                <div class="input-group">
                  <i class="bi bi-telephone"></i>
                  <input type="tel" [(ngModel)]="passenger.emergencyContact" placeholder="Emergency contact number">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seat Selection Section -->
    <div class="seat-selection-section" *ngIf="selectedBus">
      <div class="section-header">
        <div class="header-left">
          <i class="bi bi-geo-alt-fill"></i>
          <h3>ü™ë Select Your Seats</h3>
          <span class="section-subtitle">({{ getSelectedSeatsCount() }}/{{ passengers.length }} selected)</span>
        </div>
        <button class="toggle-seat-btn" (click)="toggleSeatSelection()">
          <i class="bi bi-geo-alt"></i>
          {{ showSeatSelection ? 'Hide' : 'Show' }} Seat Map
        </button>
      </div>

      <div class="seat-selection-info" *ngIf="!showSeatSelection">
        <div class="info-card">
          <i class="bi bi-info-circle"></i>
          <div class="info-text">
            <h4>Seat Selection Required</h4>
            <p>Please select {{ passengers.length }} seat(s) for {{ passengers.length }} passenger(s)</p>
            <p class="available-seats">Available seats: {{ getAvailableSeatsCount() }}</p>
          </div>
        </div>
      </div>

      <div class="seat-map-container" *ngIf="showSeatSelection">
        <div class="seat-map">
          <div class="bus-front">
            <i class="bi bi-bus-front"></i>
            <span>Front</span>
          </div>

          <div class="seat-legend">
            <div class="legend-item">
              <div class="seat-available"></div>
              <span>Available</span>
            </div>
            <div class="legend-item">
              <div class="seat-selected"></div>
              <span>Selected</span>
            </div>
            <div class="legend-item">
              <div class="seat-booked"></div>
              <span>Booked</span>
            </div>
          </div>

          <div class="seat-grid">
            <!-- Side labels -->
            <div class="side-labels">
              <div class="side-label left">Window</div>
              <div class="side-label center">Aisle</div>
              <div class="side-label right">Window</div>
            </div>

            <div class="seat-row" *ngFor="let row of seatMap">
              <div class="row-number">{{ row.row }}</div>

              <!-- Left side seats (A, B) -->
              <div class="seats left-side">
                <div class="seat"
                     *ngFor="let seat of row.seats | slice:0:2"
                     [class.available]="seat.isAvailable"
                     [class.selected]="seat.isSelected"
                     [class.booked]="seat.isBooked"
                     (click)="selectSeat(seat.number)"
                     [title]="seat.isBooked ? 'Booked' : (seat.isSelected ? 'Selected' : 'Available')">
                  {{ seat.number }}
                </div>
              </div>

              <!-- Aisle -->
              <div class="aisle">
                <div class="aisle-line"></div>
              </div>

              <!-- Right side seats (C, D) -->
              <div class="seats right-side">
                <div class="seat"
                     *ngFor="let seat of row.seats | slice:2:4"
                     [class.available]="seat.isAvailable"
                     [class.selected]="seat.isSelected"
                     [class.booked]="seat.isBooked"
                     (click)="selectSeat(seat.number)"
                     [title]="seat.isBooked ? 'Booked' : (seat.isSelected ? 'Selected' : 'Available')">
                  {{ seat.number }}
                </div>
              </div>
            </div>
          </div>

          <div class="seat-selection-summary">
            <div class="summary-item">
              <span class="label">Selected Seats:</span>
              <span class="value">{{ selectedSeats.join(', ') || 'None' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Available Seats:</span>
              <span class="value">{{ getAvailableSeatsCount() }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Summary -->
    <div class="payment-summary-card">
      <div class="summary-left">
        <div class="total-amount">
          <span class="total-label">Total: ‚Çπ{{ getTotalPrice() }}</span>
          <span class="coins-earned">Earn {{ getTotalCoins() }} coins</span>
        </div>
        <div class="passenger-info">
          For {{ passengers.length }} passenger{{ passengers.length > 1 ? 's' : '' }} ‚Ä¢
          <span *ngIf="selectedSeats.length > 0">Seats: {{ selectedSeats.join(', ') }}</span>
          <span *ngIf="selectedSeats.length === 0">Seat selection required</span>
        </div>
      </div>
      <button class="proceed-payment-btn" (click)="proceedToPayment()">
        Proceed to Payment
      </button>
    </div>
  </div>
</div>

